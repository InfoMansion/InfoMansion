# JPA - ì—°ê´€ê´€ê³„

## ë‹¤ëŒ€ì¼ [N:1] - @ManyToOne

DB í…Œì´ë¸” ì„¤ê³„ ì‹œ **N** ìª½ì— **ì™¸ë˜í‚¤** ì„¤ì •

â†’ ì™¸ë˜í‚¤ê°€ ìˆëŠ” Entityì— ì°¸ì¡°ê°’ ì„¤ì •(**ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸**)

```java
@ManyToOne
@JoinColumn(name = "member_id")
private Member member;
```

---

## ì¼ëŒ€ë‹¤ [1:N] - @OneToMany

```
ğŸ’¡ ê¶Œì¥í•˜ì§€ ì•ŠëŠ” ë°©ë²•!
ìµœëŒ€í•œ ë‹¤ëŒ€ì¼ ë‹¨ë°©í–¥ì„ ì´ìš©í•˜ì!!!
```

DB í…Œì´ë¸” ì„¤ê³„ ì‹œ ë¬´ì¡°ê±´ N ìª½ì— ì™¸ë˜í‚¤ë¥¼ ì„¤ì •í•´ì•¼í•œë‹¤.

â†’ í•˜ì§€ë§Œ ì™¸ë˜í‚¤ê°€ ì—†ëŠ”(1) Entityì— ì°¸ì¡°ê°’ ì„¤ì •

![6_1](ë…¸ìˆ˜ë¹ˆ_images/6_1.png)

Team.members.add(new Member()) ì‹œ, ì‹¤ì œë¡œëŠ” Memberí…Œì´ë¸”ì˜ Team ì™¸ë˜í‚¤ë¥¼ Updateí•˜ëŠ” ì¿¼ë¦¬ë¬¸ì´ í•œë²ˆ ë” ë‚ ë¼ê°€ê²Œ ëœë‹¤.

ë§Œì•½ ì–‘ë°©í–¥ìœ¼ë¡œ ì„¤ì •í•˜ê³  ì‹¶ë‹¤ë©´â€¦?!

**@ManyToOne @JoinColumn(name=â€fkâ€, insertable = false, updatable = false**)

**insertable = false, updatable = false** â†’ ì½ê¸°ì „ìš©ìœ¼ë¡œ ë§Œë“ ë‹¤â€¦!

---

## ì¼ëŒ€ì¼ [1:1] - @OneToOne

ì£¼ í…Œì´ë¸”ì´ë‚˜ ëŒ€ìƒ í…Œì´ë¸” ì¤‘ì— ì™¸ë˜ í‚¤ ì„ íƒ ê°€ëŠ¥

1. ì£¼ í…Œì´ë¸”ì— ì™¸ë˜ í‚¤
2. ëŒ€ìƒ í…Œì´ë¸”ì— ì™¸ë˜ í‚¤

![ì£¼ í…Œì´ë¸”ì€ MEMBER, ëŒ€ìƒ í…Œì´ë¸”ì€ LOCKERë¡œ ì„¤ì •](ë…¸ìˆ˜ë¹ˆ_images/6_2.png)

ì£¼ í…Œì´ë¸”ì€ MEMBER, ëŒ€ìƒ í…Œì´ë¸”ì€ LOCKERë¡œ ì„¤ì •

> ì£¼ í…Œì´ë¸”ì— ì™¸ë˜í‚¤ ì„¤ì •

ë‹¤ëŒ€ì¼ ë‹¨ë°©í–¥ ë§¤í•‘ê³¼ ìœ ì‚¬, **ì™¸ë˜í‚¤ê°€ ìˆëŠ” ê³³ì´ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸**

> ëŒ€ìƒ í…Œì´ë¸”ì— ì™¸ë˜í‚¤ ì„¤ì •

ì ˆëŒ€ ë¶ˆê°€ëŠ¥!!

---

## ë‹¤ëŒ€ë‹¤ [N:M] - @ManyToMany

```
ğŸ’¡ ì‹¤ë¬´ì—ì„œ ì•„ì˜ˆ ì“°ì§€ ì•ŠëŠ” ë°©ë²•
```

![Untitled](ë…¸ìˆ˜ë¹ˆ_images/6_3.png)

**@ManyToMany**
**@JoinTable(name = â€œMEMBER_PRODUCTâ€)** ì„ ì´ìš©í•˜ì—¬ ì¤‘ê°„ í…Œì´ë¸”ì„ ìƒì„±í•´ì£¼ë©´ ëœë‹¤.

â†’ @ManyToManyë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì¤‘ê°„í…Œì´ë¸”ì„ Entityë¡œ ìƒì„±í•œ í›„ @ManyToOne, @OneToManyë¥¼ ì ìš©í•˜ëŠ” ë°©ì‹ì„ ì´ìš©í•˜ì!

<br>
<br>
<br>

# JPA - ê³ ê¸‰ë§¤í•‘

## ìƒì†ê´€ê³„ ë§¤í•‘

ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ìƒì†ê´€ê³„ê°€ ì¡´ì¬í•˜ì§€ ì•Šì§€ë§Œ ê°ì²´ì—ëŠ” ì¡´ì¬í•œë‹¤.

```
ğŸ’¡ Annotation


1. @Inheritance(strategy = InheritanceType.XXX)
   - JOINED : ì¡°ì¸ì „ëµ (Defaultë¡œ ì¡°ì¸ì „ëµ ì„ íƒí•˜ì)
   - SINGLE_TABLE : ë‹¨ì¼í…Œì´ë¸” ì „ëµ (ë‹¨ìˆœí•œ ê´€ê³„ì´ë©´ ë‹¨ì¼í…Œì´ë¸”ë„ ì¢‹ë‹¤)
   - TABLE_PER_CLASS : êµ¬í˜„ í…Œì´ë¸”ë§ˆë‹¤ í…Œì´ë¸” ì „ëµ (ì‚¬ìš© X)
2. @DiscriminatorColumn
3. @DiscriminatorValue

```

### ìƒì†ê´€ê³„ ì „ëµ

- ì¡°ì¸ì „ëµ

  ![Untitled](ë…¸ìˆ˜ë¹ˆ_imgaes/../ë…¸ìˆ˜ë¹ˆ_images/7_1.png)

  ```java
  @Entity
  @Inheritance(strategy = InheritanceType.JOINED)
  @DiscriminatorColumn
  public class Item {

      @Id @GeneratedValue
      private Long id;

      private String name;
      private int price;
  }
  ```

- ë‹¨ì¼ í…Œì´ë¸” ì „ëµ

  ![Untitled](ë…¸ìˆ˜ë¹ˆ_imgaes/../ë…¸ìˆ˜ë¹ˆ_images/7_2.png)

  ```java
  @Entity
  @Inheritance(strategy = InheritanceType.SINGLE_TABLE)
  public class Item {

      @Id @GeneratedValue
      private Long id;

      private String name;
      private int price;
  }
  ```

  - ë‹¨ì¼ í…Œì´ë¸” ì „ëµì€ @DiscriminatorColumnì´ ì—†ì–´ë„ DTYPEì´ í•„ìˆ˜ë¡œ ìƒì„±ëœë‹¤.

- êµ¬í˜„ í´ë˜ìŠ¤ë§ˆë‹¤ í…Œì´ë¸” ì „ëµ - **_ì“°ë©´ ì•ˆë˜ëŠ” ì „ëµ_**

  ![Untitled](ë…¸ìˆ˜ë¹ˆ_imgaes/../ë…¸ìˆ˜ë¹ˆ_images/7_3.png)

  ```java
  @Entity
  @Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
  public abstract class Item {

      @Id @GeneratedValue
      private Long id;

      private String name;
      private int price;
  }
  ```

---

## Mapped Superclass - ë§¤í•‘ ì •ë³´ ìƒì†

ìƒì†ê´€ê³„ì™€ ìƒê´€ ì—†ì´ ê³µí†µ ì†ì„±ì´ ì¡´ì¬í•  ê²½ìš° ë”°ë¡œ classë¥¼ ìƒì„±í•˜ì—¬ ìƒì†ë°›ëŠ” ë°©ì‹(Entityê°€ ì•„ë‹˜)

â˜‘ï¸Â  ì¶”ìƒí´ë˜ìŠ¤ë¡œ ë§Œë“œëŠ” ê²ƒì„ ì¶”ì²œ

```java
@MappedSuperclass
public abstract class BaseEntity {
    private LocalDateTime createdDate;
    private LocalDateTime lastModifiedDate;
    private String createdBy;
		private String lastModifiedBy;
}
```

<br>
<br>
<br>

# JPA - í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬

## í”„ë¡ì‹œ

```
ğŸ’¡ em.find() vs em.getReference()


em.find() : ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í†µí•´ì„œ ì¡°íšŒí•œ ì—”í‹°í‹°
em.getReference() : ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒë¥¼ ë¯¸ë£¨ëŠ” ê°€ì§œ(í”„ë¡ì‹œ) ì—”í‹°í‹°

```

### í”„ë¡ì‹œì˜ íŠ¹ì§•

- ì‹¤ì œ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ ìƒì„±ëœë‹¤.
- ì‹¤ì œ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ë³´ê´€

![ì²˜ìŒì—” targetì´ ì—†ìœ¼ë¯€ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì´ˆê¸°í™” ìš”ì²­ì„ ë³´ë‚¸ë‹¤. ì‹¤ì œ Entityë¥¼ targetì— ì—°ê²°í•œë‹¤.](ë…¸ìˆ˜ë¹ˆ_images/8_1.png)

ì²˜ìŒì—” targetì´ ì—†ìœ¼ë¯€ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì´ˆê¸°í™” ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
ì‹¤ì œ Entityë¥¼ targetì— ì—°ê²°í•œë‹¤.

- í”„ë¡ì‹œ ê°ì²´ëŠ” ì²˜ìŒ ì‚¬ìš©í•  ë•Œ í•œ ë²ˆë§Œ ì´ˆê¸°í™”!!
  - ì´ˆê¸°í™” ì‹œ í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ì—”í‹°í‹°ë¡œ ë°”ë€ŒëŠ” ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— íƒ€ì… ì²´í¬ ì‹œ `instance of`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- ë§Œì•½ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì°¾ëŠ” Entityê°€ ì¡´ì¬í•œë‹¤ë©´ Proxyê°€ ì•„ë‹Œ ì‹¤ì œ Entityë¡œ ë³€ê²½ëœë‹¤.
- ì¤€ì˜ì† ìƒíƒœì¼ ë•Œ í”„ë¡ì‹œ ì´ˆê¸°í™” ë¬¸ì œ ë°œìƒ

### í”„ë¡ì‹œ í™•ì¸

```java
/*
í”„ë¡ì‹œ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™” ì—¬ë¶€
*/
emf.getPersistenceUnitUtil().isLoaded(findMember);

/*
í”„ë¡ì‹œ í´ë˜ìŠ¤ í™•ì¸ ë°©ë²•
*/
entity.getClass();

/*
í”„ë¡ì‹œ ê°•ì œ ì´ˆê¸°í™”
*/
Hibernate.initialize(entity);
```

### ì™œ Proxyë¥¼ ë°°ìš°ëŠ”ê°€?

ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©ì— ëŒ€í•´ ì´í•´í•˜ê¸° ìœ„í•´ì„œâ€¦!

---

## ì¦‰ì‹œë¡œë”©ê³¼ ì§€ì—°ë¡œë”©

`â“ Memberë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ê´€ê³„ì¸ Teamë„ í•¨ê»˜ ì¡°íšŒí•´ì•¼ í• ê¹Œ? â†’ ê°€ì¥ í° ê³ ë¯¼ì `

### ì§€ì—°ë¡œë”© (Lazy)

```java
@ManyToOne(fetch = FetchType.LAZY)    // Lazy í”„ë¡ì‹œ ì„¤ì •
@JoinColumn(name = "TEAM_ID")
private Team team;
```

```java
// ì´ ë‹¹ì‹œì—ëŠ” Memberë§Œ ì¡°íšŒ!
Member m = em.find(Member.class, member.getId());

// ì´ ë•ŒëŠ” Teamì—ëŒ€í•œ Proxy ìƒì„±
System.out.println("m = " + m.getTeam().getClass());

// ì‹¤ì œ Teamì„ ì‚¬ìš©í•˜ëŠ” ì‹œì ì—ì„œ targetì´ ì¡°íšŒ
m.getTeam().getName();
```

### ì¦‰ì‹œë¡œë”© (EAGER)

```java
@ManyToOne(fetch = FetchType.EAGER)    // EAGER í”„ë¡ì‹œ ì„¤ì •
@JoinColumn(name = "TEAM_ID")
private Team team;
```

```java
// ì´ ë‹¹ì‹œì—ëŠ” Memberì™€ Team ì „ë¶€ ì¡°íšŒ
Member m = em.find(Member.class, member.getId());

// ì´ë¯¸ ì¡°íšŒê°€ ëœ ìƒíƒœì´ë¯€ë¡œ Proxyê°€ ì•„ë‹Œ Team Entity ì¶œë ¥
System.out.println("m = " + m.getTeam().getClass());
m.getTeam().getName();
```

### ğŸ™ğŸ» ì‹¤ë¬´ì—ì„œëŠ” ì¦‰ì‹œë¡œë”©ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ğŸ™ğŸ»

ê°€ê¸‰ì  ì§€ì—°ë¡œë”©ë§Œ ì‚¬ìš©í•œë‹¤. â†’ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œ ë°œìƒ

- ì¦‰ì‹œ ë¡œë”©ì„ ì ìš©í•˜ë©´ JOIN ì‹œ ì˜ˆìƒí•˜ì§€ ëª»í•œ SQL ë¬¸ì œ ë°œìƒ
- ì¦‰ì‹œ ë¡œë”©ì—ì„œëŠ” JPQLì—ì„œ N+1 ë¬¸ì œ ë°œìƒ
  - JPQL select ì¿¼ë¦¬ 1ë²ˆ ë‚ ë¦° í›„ ê²°ê³¼ ê°œìˆ˜ Nê°œì— ëŒ€í•´ ì—°ê´€ê´€ê³„ë¥¼ ê°€ì ¸ì˜¤ê³ ì Në²ˆì˜ ì¿¼ë¦¬ë¥¼ ì¶”ê°€ë¡œ ë‚ ë¦¼ â‡’ N+1 ë¬¸ì œ
  - ì§€ì—°ë¡œë”©ìœ¼ë¡œ í•´ê²°ê°€ëŠ¥í•˜ì§€ë§Œ fetch join / Entity Graph ë°©ë²•ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥

---

## ì˜ì†ì„± ì „ì´ : CASCADE

```
ğŸ’¡ ë¶€ëª¨ë¥¼ ì €ì¥í•  ë•Œ ì—°ê´€ëœ ìì‹ë„ persistë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥


```

```java
Child child1 = new Child();
Child child2 = new Child();

Parent parent = new Parent();

parent.addChild(child1);
parent.addChild(child2);

// persist ì‹œ 3ì¤„ì˜ ì½”ë“œê°€ í•„ìš”í•¨...
em.persist(child1);
em.persist(child2);
em.persist(parent);
```

â¬‡ï¸

```java
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
private List<Child> childList = new ArrayList<>();
```

```java
Child child1 = new Child();
Child child2 = new Child();

Parent parent = new Parent();

parent.addChild(child1);
parent.addChild(child2);

em.persist(parent);
```

---

## ê³ ì•„ ê°ì²´

ë¶€ëª¨ ì—”í‹°í‹°ì™€ ì—°ê´€ê´€ê³„ê°€ ëŠì–´ì§„ ìì‹ ì—”í‹°í‹°ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ `orphanRemoval = true`

- íŠ¹ì • ì—”í‹°í‹°ê°€ ê°œì¸ ì†Œìœ í•  ë•Œ ì‚¬ìš©
